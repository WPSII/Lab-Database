{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Samples</h2>
  <div class="d-flex align-items-center gap-2">
    <form class="d-flex" method="get" action="{{ url_for('list_samples') }}">
      <input type="hidden" name="view" value="{{ view }}">
      <input class="form-control me-2" name="q" value="{{ q or '' }}" placeholder="Search samples...">
      <button class="btn btn-outline-secondary">Search</button>
    </form>
    <div class="btn-group">
      <a class="btn btn-sm {% if view != 'project' %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{{ url_for('list_samples', view='flat', q=q) }}">Flat</a>
      <a class="btn btn-sm {% if view == 'project' %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{{ url_for('list_samples', view='project', q=q) }}">By Project</a>
    </div>
  </div>
</div>

{% if view == 'flat' %}
  <ul class="list-group mb-4">
    {% for s in samples %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a href="{{ url_for('view_sample', sample_id=s.id) }}">{{ s.name }}</a>
          <div class="small text-muted">
            Project: <a href="{{ url_for('view_project', project_id=s.project.id) }}">{{ s.project.title }}</a>
            {% if s.manufacturer %} · {{ s.manufacturer }}{% endif %}
            · {{ s.experiment_links | length }} linked experiment{% if (s.experiment_links | length) != 1 %}s{% endif %}
          </div>
        </div>
        <small class="text-muted">{{ s.created_at.strftime('%Y-%m-%d') }}</small>
      </li>
    {% else %}
      <li class="list-group-item">No samples yet.</li>
    {% endfor %}
  </ul>
{% else %}
  {# --- Project tree view with recursion --- #}
  {% macro render_tree(node) -%}
    <li>
      <a href="{{ url_for('view_sample', sample_id=node.id) }}">{{ node.name }}</a>
      {% if node.children %}
        <ul>
          {% for c in node.children %}
            {{ render_tree(c) }}
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {%- endmacro %}

  {% for p in projects %}
    <div class="card card-body mb-3">
      <h5 class="mb-2">
        <a href="{{ url_for('view_project', project_id=p.id) }}">{{ p.title }}</a>
      </h5>
      {% set roots = roots_by_project.get(p.id, []) %}
      {% if roots %}
        <ul class="mb-0">
          {% for r in roots %}
            {{ render_tree(r) }}
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No samples in this project.</p>
      {% endif %}
    </div>
  {% endfor %}
{% endif %}

<!-- Create Sample -->
<div class="card card-body" style="max-width: 900px;">
  <h5 class="mb-3">Create Sample</h5>
  <!-- (Place inside the Create Sample form) -->
    <div class="row g-2 mt-2">
        <div class="col-md-6">
            <label class="form-label">Link Experiment (optional)</label>
            <select class="form-select" id="experiment-select" name="experiment_id" disabled>
                <option value="">Select a project first…</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Role</label>
            <select class="form-select" name="role">
                <option value="irradiation">irradiation</option>
                <option value="corrosion">corrosion</option>
                <option value="polishing">polishing</option>
                <option value="other" selected>other</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Notes (optional)</label>
            <input class="form-control" name="notes" placeholder="e.g., fluence/temp/media">
        </div>
    </div>

  <form method="post" action="{{ url_for('create_sample') }}">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Project</label>
        <select class="form-select" id="project-select" name="project_id" required>
          <option value="">Select a project…</option>
          {% for p in projects %}
            <option value="{{ p.id }}">{{ p.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Parent Sample (optional)</label>
        <select class="form-select" id="parent-select" name="parent_id" disabled>
          <option value="">Select a project first…</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Sample Name</label>
        <input class="form-control" name="name" required placeholder="e.g., SS316H Heat A">
      </div>
    </div>

    <!-- Dynamic project-defined attributes -->
    <div class="mt-3" id="dyn-attrs" style="display:none;">
      <h6 class="mb-2">Project-required Attributes</h6>
      <div id="dyn-attrs-fields"></div>
      <div class="form-text">
        These fields are defined by the project owner.
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-primary" id="create-btn" disabled>Create Sample</button>
    </div>
  </form>
</div>

<!-- ONE clean data block: parent candidate samples (id, name, project_id) -->
<script id="sample-data" type="application/json">{{ sample_opts | tojson }}</script>

<script>
(function(){
  const projSel   = document.getElementById('project-select');
  const parentSel = document.getElementById('parent-select');
  const wrap      = document.getElementById('dyn-attrs');
  const container = document.getElementById('dyn-attrs-fields');
  const createBtn = document.getElementById('create-btn');

  // parse precomputed safe data from the server
  let sampleData = [];
  try { sampleData = JSON.parse(document.getElementById('sample-data').textContent || '[]'); }
  catch(_) { sampleData = []; }

  function resetSel(sel, placeholder){
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = placeholder || '';
    sel.appendChild(opt);
  }

  function populateParents(pid){
    if (!pid) {
      parentSel.disabled = true;
      resetSel(parentSel, 'Select a project first…');
      return;
    }
    const sams = sampleData.filter(s => s.project_id === Number(pid));
    parentSel.disabled = false;
    resetSel(parentSel, '(optional) Select a parent…');
    sams.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      parentSel.appendChild(opt);
    });
  }

  function clearDyn(){ container.innerHTML = ''; }
  function toggleCreate(enabled){ createBtn.disabled = !enabled; }

  async function loadAttrs(pid){
    clearDyn();
    if (!pid) { wrap.style.display = 'none'; toggleCreate(false); return; }
    try {
      const resp = await fetch(`/api/project/${pid}/sample-attrs`);
      const attrs = await resp.json();

      if (!attrs.length) {
        wrap.style.display = 'none';
        toggleCreate(true); // allow creation even if project has no attrs
        return;
      }

      wrap.style.display = '';
      attrs.forEach(a => {
        const id = `attr_${a.id}`;
        const group = document.createElement('div');
        group.className = 'mb-2';

        const label = document.createElement('label');
        label.className = 'form-label';
        label.setAttribute('for', id);
        label.textContent = a.name + (a.required ? ' *' : '');

        let input;
        if (a.field_type === 'select') {
          input = document.createElement('select');
          input.className = 'form-select';
          input.name = id; input.id = id;
          if (!a.required) {
            const opt = document.createElement('option'); opt.value = ''; opt.textContent = '(optional)';
            input.appendChild(opt);
          }
          (a.choices || []).forEach(v => {
            const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
            input.appendChild(opt);
          });
        } else {
          input = document.createElement('input');
          input.className = 'form-control';
          input.name = id; input.id = id;
          input.type = (a.field_type === 'number' ? 'number'
                    :  a.field_type === 'date'   ? 'date' : 'text');
          if (!a.required) input.placeholder = '(optional)';
        }
        if (a.required) input.required = true;

        group.appendChild(label);
        group.appendChild(input);
        container.appendChild(group);
      });

      toggleCreate(true); // browser 'required' will enforce at submit
    } catch (e) {
      console.error('Failed to load project sample attributes', e);
      wrap.style.display = 'none';
      toggleCreate(false);
    }
  }

  projSel.addEventListener('change', function(){
    const pid = this.value;
    populateParents(pid);
    loadAttrs(pid);
  });

  // prefill on reload if project already selected
  if (projSel.value) {
    populateParents(projSel.value);
    loadAttrs(projSel.value);
  } else {
    toggleCreate(false);
  }
})();
</script>

{% endblock %}
